name: ðŸ”„ Master Timed Scraper Batch 

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for dispatching the orchestrator'
        required: false
        default: 'Timed sequential run'

# Permissions are essential for dispatching other workflows
permissions:
  actions: write 
  contents: read

jobs:
  trigger_workflows:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # --- STEP 1: Simultaneously Trigger Batch 1 and Batch 2 ---
      - name: ðŸš€ Trigger Batch 1 and Batch 2 (Concurrent Group 1)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dispatch = async (workflowFile) => {
              console.log(`Dispatching workflow: ${workflowFile}`);
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                ref: context.ref,
                inputs: {} 
              });
              console.log(`Successfully dispatched ${workflowFile}`);
            };

            // Trigger scraper_batch1.yml simultaneously
            dispatch('scraper_batch1.yml'); 
            
            // Trigger scraper_batch2.yml simultaneously
            dispatch('scraper_batch2.yml'); 
            // Note: The lack of 'await' between dispatches makes them run concurrently.


      # -----------------------------------------------------------------
      # --- STEP 2: Wait 12 Minutes ---
      - name: â³ Wait for 12 minutes (Before Group 2)
        uses: actions/github-script@v6
        with:
          script: |
            // Delay for 12 minutes (12 * 60 * 1000 milliseconds)
            const delay = 12 * 60 * 1000; 
            console.log(`Waiting for ${delay / 1000 / 60} minutes...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            console.log('Wait complete, proceeding to Batch 3 and 4.');


      # -----------------------------------------------------------------
      # --- STEP 3: Simultaneously Trigger Batch 3 and Batch 4 ---
      - name: ðŸš€ Trigger Batch 3 and Batch 4 (Concurrent Group 2)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dispatch = async (workflowFile) => {
              console.log(`Dispatching workflow: ${workflowFile}`);
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                ref: context.ref,
                inputs: {}
              });
              console.log(`Successfully dispatched ${workflowFile}`);
            };

            // Trigger scraper_batch3.yml simultaneously
            dispatch('scraper_batch3.yml'); 
            
            // Trigger scraper_batch4.yml simultaneously
            dispatch('scraper_batch4.yml'); 


      # -----------------------------------------------------------------
      # --- STEP 4: Optional cleanup step or simple completion log ---
      - name: âœ… Orchestration Complete
        run: echo "All scraper batches have been dispatched."
